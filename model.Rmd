---
title: "NHL Shot Effectiveness Model"
author: "Sasank Vishnubhatla"
date: "February 8th, 2019"
runtime: shiny
output:
  html_document:
    theme: simplex
    df_print: paged
---

```{r global_options, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

Last Update: `r Sys.time()`

# Libraries

Before we start, let's load a few libraries.

```{r libraries}
rm(list = ls())

options(warn = -1)

library(knitr)
library(ggplot2)
library(caret)
library(doParallel)

registerDoParallel(cores = (detectCores() - 1))
```

With our libraries loaded we can start loading our data.

# Data Loading

Let's read in our data.

```{r read_csv}
data.2015 = read.csv("data/2015.csv")
data.2016 = read.csv("data/2016.csv")
data.2017 = read.csv("data/2017.csv")
data.2018 = read.csv("data/2018.csv")
```

Now, we will only deal with regular season events. So let's remove the playoffs from our datasets.

```{r remove_playoffs}
get.regular.season = function(data) {
	subset(data, isPlayoffGame == 0)
}

season.2015 = get.regular.season(data.2015)
season.2016 = get.regular.season(data.2016)
season.2017 = get.regular.season(data.2017)
season.2018 = get.regular.season(data.2018)
```

Here is a table of all the columns we shall keep and what we shall rename them to.

| Old Column Name | New Column Name |
| --------------- | --------------- |
| `xCordAdjusted` | `x` |
| `yCordAdjusted` | `y` |
| `shotAngleAdjusted` | `angle` |
| `shotDistance` | `dist` |
| `teamCode` | `team` |
| `shotType` | `type` |

```{r get_helpful_data}
get.helpful.data = function(data) {
	data.frame(x = data$xCordAdjusted,
			   y = data$yCordAdjusted,
			   angle = data$shotAngleAdjusted,
			   dist = data$shotDistance,
			   type = as.numeric(data$shotType),
			   goal = data$goal,
			   team = data$teamCode)
}

# type:
# 1 -> empty
# 2 -> BACK
# 3 -> DEFL
# 4 -> SLAP
# 5 -> SNAP
# 6 -> TIP
# 7 -> WRAP
# 8 -> WRIST

analysis.2015 = get.helpful.data(season.2015)
analysis.2016 = get.helpful.data(season.2016)
analysis.2017 = get.helpful.data(season.2017)
analysis.2018 = get.helpful.data(season.2018)
```

Now, we can remove incomplete cases and create our machine learning model's giant data set.

```{r incomplete_cases}
analysis.2015 = analysis.2015[complete.cases(analysis.2015),]
analysis.2016 = analysis.2016[complete.cases(analysis.2016),]
analysis.2017 = analysis.2017[complete.cases(analysis.2017),]
analysis.all = rbind(analysis.2017, rbind(analysis.2016, analysis.2015))
analysis.all = analysis.all[complete.cases(analysis.all),]
analysis.2018 = analysis.2018[complete.cases(analysis.2018),]
```

Here's what `analysis.2018` looks like:

```{r view_analysis}
analysis.2018
```

Now, we need a few functions to help us select certain subsets of data. We'll define three functions: `get.team.data`, `get.shooter.data`, `get.goalie.data`.

```{r data_functions}
get.team.data = function(data, code) {
	subset(data, team == code)
}
```

# Calculating Statistics

We can calculate a few statistics, like goal (effective) percentage for a certain shot. Let's write a function to do that right now.

```{r goal_perc}
calculate.goal.percentage = function(data) {
	goals = sum(data$goal == 1)
	total = nrow(data)
	goals / total
}
```

So, for example, Penguins's goal percentage against slap shots would be calculated as follows:

```{r murray_slap}
penguins.2018 = get.team.data(analysis.2018, "PIT")
penguins.2018.slap = subset(penguins.2018, type == 4)
penguins.2018.slap.eff = calculate.goal.percentage(penguins.2018.slap)
```

His goal percentage is `r murray.2018.slap.eff`.

# Creating the Models

Using the `caret` package, we can build machine learning models to help us determine which shot type is best.

Let's get started with training our control.

```{r control}
control = trainControl(method = "repeatedcv", number = 5, repeats = 3)
```

Now we will train a few different types of models. Here is a list of the models we will train:

- Neural Network
- K Nearest Neighbors

```{r models}
model.nnet = train(goal ~ . -goal -team,
				   data = analysis.all,
				   method = "nnet",
				   trControl = control)
model.knn = train(goal ~ . -goal -team,
				  data = analysis.all,
				  method = "knn",
				  trControl = control)
```

Now our models have been made.

# Testing the Models

Let's test our models on the 2018 data. Here's what the testing data looks like:

```{r testing_data}
analysis.2018
```

Now, let's get our predictions:

```{r get_predictions}
nnet.prediction = predict(model.nnet, newdata = analysis.2018)
knn.prediction = predict(model.knn, newdata = analysis.2018)

nnet.prediction.data = data.frame(analysis.2018)
nnet.prediction.data$predict = nnet.prediction

knn.prediction.data = data.frame(analysis.2018)
knn.prediction.data$predict = knn.prediction
```

So, our Neural Network data looks like:

```{r nnet_data}
nnet.prediction.data
```

Our K-Nearest Neighbors data looks like:

```{r knn_data}
knn.prediction.data
```

# Examples {.tabset .tabset-fade}

## Pittsburgh Penguins

## Vegas Golden Knights

## Winnipeg Jets